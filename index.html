<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
    font: 10px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.distribution {
    fill: none;
    stroke: #000;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var DELEGATES = {
    AS: 1,
    DC: 1,
    GU: 1,
    MP: 1,
    PR: 1,
    VI: 1
};

var noLabel = function() { return ''; };
var percentage = d3.format('.0%');

var width = 550,
    height = 150,
    margin = 10,
    widthSvg = width + 2*margin + 5,
    heightSvg = height + 2*margin + 10;

var x = d3.scale.linear()
    .domain([0.45, 1])
    .range([0, width]);

var y = d3.scale.linear()
    .domain([0, 100])
    .range([height, 0]);

var percentile = d3.scale.quantile()
    .range(d3.range(0,100));

var xAxis = d3.svg.axis()
    .orient('bottom')
    .scale(x)
    .tickFormat(percentage)
    .tickValues([0.5,0.75,1]);

var yAxis = d3.svg.axis()
    .orient('left')
    .scale(y)
    .tickFormat(noLabel)
    .tickValues([0,25,50,75,100]);

var cdfLine = d3.svg.line()
    .x(function(d) { return x(d); })
    .y(function(d, i) { return y(i); })
    .interpolate('basis');

function cleanRecord(d) {
    d.name = d.name.trim();
    d.state = d.state.trim();
    d.district = d.state + '-' + d.district.trim();
    d.incumbent = d.incumbent == 1;
    d.result = +d.result;
}

function setYear(year) {
    return function(d) {
        d.year = year;
    }
}

function isRepresentative(d) {
    return !(d.state in DELEGATES);
}

function loadYear(year, cb) {
    d3.csv('data/'+year+'.csv', function(error, districts) {
        districts.forEach(cleanRecord);
        districts.forEach(setYear(year));
        cb( districts.filter(isRepresentative) );
    });
}

var years = [];
var remainingYears = [];

for ( var i = 2000; i <= 2012; i += 2 ) {
    remainingYears.push(i);
    loadYear(i, function(d) {
        percentile.domain(d.map(function(r) { return r.result; } ));
        var cutoff = percentile.quantiles();
        cutoff.push(1);
        cutoff.splice(0, null, 0);
        years.push({
            year: d[0].year,
            cutoffs: cutoff
        });
        remainingYears.pop();
        checkComplete();
    });
}

function checkComplete() {
    if ( remainingYears.length ) return;

    var g = d3.select('body').append('svg')
        .attr('width', widthSvg)
        .attr('height', heightSvg)
        .append('g')
        .attr('transform', 'translate('+margin+','+margin+')');

    g.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,'+height+')')
        .call(xAxis);
    g.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    g.selectAll('.distribution')
        .data(years)
        .enter().append('path')
        .attr('class', 'distribution')
        .attr('d', function(d){ return cdfLine(d.cutoffs); });
}

</script>
